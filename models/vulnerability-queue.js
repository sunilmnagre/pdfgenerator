const models = require('../db_models');
const vulnerabilityQuery = require('../jobs/tenable/job-get-scan-result').getVulnerabilityJobQuery;
const vulnerabilityJobQueueModel = models.VulnerabilitiesJobQueue;

const create = async (organisationId, jobType, scanResult) => {
    
    let baseQuery = vulnerabilityQuery(organisationId, jobType, parseInt(scanResult.scanId), parseInt(scanResult.id), parseInt(scanResult.finishTime));

    // If it isn't already on the queue, add it
    let duplicateResult = await models.sequelize.query(baseQuery, { type: models.Sequelize.QueryTypes.SELECT })
    
    if (duplicateResult.length === 0) {
        let vulnerablityJobQueueObject = {
            scanResultId: parseInt(scanResult.id),
            scan_id: parseInt(scanResult.scanId),
            scan_start: parseInt(scanResult.startTime),
            scan_end: parseInt(scanResult.finishTime),
            last_modification_date: parseInt(scanResult.finishTime)
        };

        let result = await vulnerabilityJobQueueModel.create({
            organisation_id: organisationId,
            job_type: jobType,
            params: JSON.stringify(vulnerablityJobQueueObject),
            status: null,
            attempts: 0
        });
        return result;
    }  
    return duplicateResult;
} 

module.exports = {
    create
};